<mat-card class="inspector-card">
  <div #card (window:resize)="titleWidth=card.getBoundingClientRect().width" class="wrapper">
    <div class="fields-wrapper">
      <mat-card-header>
        <mat-card-subtitle class="text-oneline" [style.width.px]="titleWidth - 130">
          @if (!target) {
            Click graph item to view
          }
          @if (target) {
            {{target.type | titlecase}}
          }
          @if (latestConfig && target && target.type === 'vertex') {
            - {{latestConfig[target.data.collection].name}}
          }
        </mat-card-subtitle>
        <mat-card-title class="text-oneline" [style.width.px]="titleWidth - 130">
          @if (target && target.type === 'vertex') {
            {{target.data.name}}
          }
          @if (target && target.type === 'edge') {
            {{target.data.name | titlecase}}
          }
          @if (!target) {
            Inspector
          }
        </mat-card-title>
      </mat-card-header>
    </div>
    @if (target) {
      <div class="fields-wrapper">
        <button mat-icon-button [matMenuTriggerFor]="menu" aria-label="Inspector menu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #menu="matMenu">
          <ng-template matMenuContent>
            <button mat-menu-item [disabled]="!(user.roles.includes('admin') || isTargetOwner) || (target.type === 'vertex' && latestConfig && !latestConfig[target.data.collection].permissions.update)" (click)="editTarget()">
              <mat-icon>edit</mat-icon>
              <span>Edit</span>
            </button>
            @if (target.type === 'vertex') {
              <button mat-menu-item (click)="toggleNavigationFollows()">
                <mat-icon>{{this.navigationFollows === 'vertex' ? 'east' : 'radio_button_unchecked' }}</mat-icon>
                <span>{{this.navigationFollows === 'vertex' ? 'Follow Edge' : 'Follow Vertex'}}</span>
              </button>
            }
            <mat-divider></mat-divider>
            <button mat-menu-item [disabled]="!(user.roles.includes('admin') || isTargetOwner) || (target.type === 'vertex' && latestConfig && !latestConfig[target.data.collection].permissions.delete)" (click)="deleteTarget()">
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </ng-template>
        </mat-menu>

        <button mat-icon-button class="copy-id" aria-label="Copy Id" [cdkCopyToClipboard]="getTargetId()">
          <mat-icon>content_copy</mat-icon>
        </button>
      </div>
    }
  </div>
  <mat-card-content>
    <mat-divider></mat-divider>
    @if (target) {
      <div>
        @if (target.type === 'edge') {
          <div>
            <h3 class="edge-heading">Source@if (latestData && target && latestConfig) {
              - {{latestConfig[latestData.idToVertex[target.data.source].collection].name}}
            }</h3>
            <div class="wrapper vertex-edge-type-container">
              <div class="fields-wrapper">
                <mat-chip-listbox [selectable]="false">
                  <mat-chip-option (click)="selectVertex(target.data.source)">
                    <app-vertex-name [vertex]="(edgeConnections | async)?.sourceVertex"></app-vertex-name>
                  </mat-chip-option>
                </mat-chip-listbox>
              </div>
              <div class="fields-wrapper">
                @if (target) {
                  <button mat-icon-button class="copy-id" aria-label="Copy Id" [cdkCopyToClipboard]="getEdgeSourceId()">
                    <mat-icon>content_copy</mat-icon>
                  </button>
                }
              </div>
            </div>
            <h3 class="edge-heading">Target@if (latestData && target && latestConfig) {
              - {{latestConfig[latestData.idToVertex[target.data.target].collection].name}}
            }</h3>
            <div class="wrapper vertex-edge-type-container">
              <div class="fields-wrapper">
                <mat-chip-listbox [selectable]="false">
                  <mat-chip-option (click)="selectVertex(target.data.target)">
                    <app-vertex-name [vertex]="(edgeConnections | async)?.targetVertex"></app-vertex-name>
                  </mat-chip-option>
                </mat-chip-listbox>
              </div>
              <div class="fields-wrapper">
                @if (target) {
                  <button mat-icon-button class="copy-id" aria-label="Copy Id" [cdkCopyToClipboard]="getEdgeTargetId()">
                    <mat-icon>content_copy</mat-icon>
                  </button>
                }
              </div>
            </div>
          </div>
        }
        @if (target.type === 'vertex') {
          <div>
            @if ((collectionData | collectionFilter | keyvalue).length > 0 && latestConfig) {
              <table mat-table [dataSource]="collectionData | collectionFilter | keyvalue">
                <!-- Key Column -->
                <ng-container matColumnDef="key">
                  <th mat-header-cell *matHeaderCellDef> Key </th>
                  <td mat-cell *matCellDef="let element"> {{latestConfig[target.data.collection].fields[element.key].name}} </td>
                </ng-container>
                <!-- Value Column -->
                <ng-container matColumnDef="value">
                  <th mat-header-cell *matHeaderCellDef> Value </th>
                  <td mat-cell *matCellDef="let element">
                    <span class="ellipsis">
                    @switch (getFieldType(element.key)) {
                        @case ('boolean') {
                          @if (element.value) {
                            Yes
                          }
                          @if (!element.value) {
                            No
                          }
                        }
                        @case ('email') {
                          {{element.value}}
                        }
                        @case ('json') {
                          <a mat-stroked-button (click)="viewCollectionJson(element.value)">View</a>
                        }
                        @case ('string') {
                          {{element.value}}
                        }
                        @case ('stringArray') {
                          {{element.value.join(', ')}}
                        }
                        @case ('url') {
                          {{element.value}}
                        }
                        @default {
                        }
                    }
                  </span>
                  </td>
                </ng-container>
                <tr mat-header-row *matHeaderRowDef="propDisplayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: propDisplayedColumns;"></tr>
              </table>
              <mat-divider></mat-divider>
            }
            @if (target.data.collection === 'brokerAccount') {
              <app-inspector-account [account]="collectionData" [userIndex]="latestConfig?.['user']?.index"></app-inspector-account>
            }
            @if (target.data.collection === 'service') {
              <app-inspector-intentions [target]="target"></app-inspector-intentions>
              <app-inspector-service-secure
                [service]="collectionData"
              [userIndex]="latestConfig?.['user']?.index"></app-inspector-service-secure>
            }
            @if (target.data.collection === 'serviceInstance') {
              <app-inspector-installs [instance]="collectionData"></app-inspector-installs>
            }
            @if (target.data.collection === 'team') {
              <app-inspector-team [instance]="collectionData" (graphChanged)="refreshData()"></app-inspector-team>
            }
            <div class="wrapper vertex-edge-container">
              <div class="fields-wrapper">
                <h3 class="vertex-heading">Inbound</h3>
              </div>
              @if (latestConfig && latestConfig[target.data.collection].edges.length > 0) {
                <div class="fields-wrapper" >
                  <button mat-button (click)="openDeleteEdgeDialog(inboundConnections)" [disabled]="!user.roles.includes('admin') ||
                  ((inboundConnections | async)?.connections | keyvalue)?.length == 0">Delete</button>
                </div>
              }
            </div>
            @if (((inboundConnections | async)?.connections | keyvalue)?.length == 0) {
              <p class="vertex-edge-type-container">None</p>
            }
            @for (group of $any((inboundConnections | async)?.connections | keyvalue); track group) {
              <div class="vertex-edge-type-container">
                <h5>{{group.key | titlecase}}</h5>
                <mat-chip-listbox [selectable]="false">
                  @for (item of group.value; track item) {
                    <mat-chip-option (click)="navigateConnection(item)">@if (item.vertex.parentName) {
                      {{ item.vertex.parentName}} &gt;
                    }{{item.vertex.name}}</mat-chip-option>
                  }
                </mat-chip-listbox>
              </div>
            }
            <mat-divider></mat-divider>
            <div class="wrapper vertex-edge-container">
              <div class="fields-wrapper">
                <h3 class="vertex-heading">Outbound</h3>
              </div>
              @if (latestConfig && latestConfig[target.data.collection].edges.length > 0) {
                <div class="fields-wrapper" >
                  <button mat-button (click)="addEdgeToVertex(target.data)" [disabled]="!user.roles.includes('admin')">Add</button>
                  <button mat-button (click)="openDeleteEdgeDialog(outboundConnections)" [disabled]="!user.roles.includes('admin') ||
                  ((outboundConnections | async)?.connections | keyvalue)?.length == 0">Delete</button>
                </div>
              }
            </div>
            @if (((outboundConnections | async)?.connections | keyvalue)?.length == 0) {
              <p class="vertex-edge-type-container">None</p>
            }
            @for (group of $any((outboundConnections | async)?.connections | keyvalue); track group) {
              <div class="vertex-edge-type-container">
                <h5>{{group.key | titlecase}}</h5>
                <mat-chip-listbox [selectable]="false">
                  @for (item of group.value; track item) {
                    <mat-chip-option (click)="navigateConnection(item)">@if (item.vertex.parentName) {
                      {{ item.vertex.parentName}} &gt;
                    } {{item.vertex.name}}</mat-chip-option>
                  }
                </mat-chip-listbox>
              </div>
            }
            <mat-divider></mat-divider>
            @if (latestData && collectionPeople && collectionPeople.length > 0) {
              <div class="wrapper vertex-edge-container">
                <div class="fields-wrapper">
                  <h3 class="vertex-heading">People</h3>
                </div>
                <table mat-table [dataSource]="collectionPeople">
                  <!-- Type Column -->
                  <ng-container matColumnDef="role">
                    <th mat-header-cell *matHeaderCellDef> Role </th>
                    <td mat-cell *matCellDef="let element"> {{element.path.name}} </td>
                  </ng-container>
                  <!-- Name Column -->
                  <ng-container matColumnDef="name">
                    <th mat-header-cell *matHeaderCellDef> Name </th>
                    <td mat-cell *matCellDef="let element"> {{element.collection.name}} </td>
                  </ng-container>
                  <!-- Name Column -->
                  <ng-container matColumnDef="via">
                    <th mat-header-cell *matHeaderCellDef> Via </th>
                    <td mat-cell *matCellDef="let element"> {{latestData.idToVertex[element.path.target].name}} ({{latestData.idToVertex[element.path.target].collection}}) </td>
                  </ng-container>
                  <tr mat-header-row *matHeaderRowDef="propPeopleDisplayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: propPeopleDisplayedColumns;"></tr>
                </table>
                <mat-divider></mat-divider>
              </div>
            }
          </div>
        }
        @if (target && target.data.prop) {
          <div>
            <h3 class="property-heading">Properties</h3>
            <table mat-table [dataSource]="target.data.prop | keyvalue">
              <!-- Key Column -->
              <ng-container matColumnDef="key">
                <th mat-header-cell *matHeaderCellDef> Key </th>
                <td mat-cell *matCellDef="let element"> {{element.key}} </td>
              </ng-container>
              <!-- Value Column -->
              <ng-container matColumnDef="value">
                <th mat-header-cell *matHeaderCellDef> Value </th>
                <td mat-cell *matCellDef="let element"> {{element.value}} </td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="propDisplayedColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: propDisplayedColumns;"></tr>
            </table>
          </div>
        }
      </div>
    }
  </mat-card-content>
</mat-card>
